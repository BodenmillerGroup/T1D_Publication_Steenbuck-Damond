#-------------------------------------------------------------------
# Description
#-------------------------------------------------------------------
## This workflow runs the T1D_analysis code on the S3it cluster.
## The dataset contains 2 panels, which are defined via wildcards. 
## Hence, preprocessing of the panels occurs in parallel. 

# Scope:
## Start: After extraction of features after pre-processing 
## Mid: Import, Spillover Compensation, Transformation, QC,
## End: Cell-Type Annotation.

#-------------------------------------------------------------------
# Container
#-------------------------------------------------------------------
## Stores all dependencies (R & Python).
## Hosted on docker-hub.
container: "/data/nsteen/singularity/sandbox"

#-------------------------------------------------------------------
# Output
#-------------------------------------------------------------------
## Snakemake: Figure out how to generate these 2 files.
rule targets:
    input: 
        "docs/08_CellTypesNonImmune_cells_Immune.html", # Immune Panel
        "docs/08_CellTypesNonIslet_cells_Islet.html" # Islet Panel.

#-------------------------------------------------------------------
# R-Scripts
#-------------------------------------------------------------------
## Define Analysis Rules.
#-------------------------------------------------------------------
## 1) Import of pre-processed data.
rule ImportData_cells_01_r:
    input:
        script="analysis/01_ImportData_cells_{panel}.Rmd",
        helper_script="analysis/helpers.R",
        prev_out="processing/txt_output/05_ImageRegistration.out"
    output:
        "docs/01_ImportData_cells_{panel}.html",
    benchmark:
        "benchmark/01_import_{panel}.txt"
    threads: 8
    resources:
        mem_mb=170000,
        time="5:00:00"
    script:
        "analysis/01_ImportData_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 2) SpillOver-Compensation.
rule SpilloverCompensation_cells_02_r:
    input:
        script="analysis/02_SpilloverCompensation_cells_{panel}.Rmd",
        prev_out="docs/01_ImportData_cells_{panel}.html"
    output:
        "docs/02_SpilloverCompensation_cells_{panel}.html",
    benchmark:
        "benchmark/02_SpilloverCompensation_cells_{panel}.txt"
    threads: 8
    resources:
        mem_mb=80000, #80GB,
        time="5:00:00"
    script:
        "analysis/02_SpilloverCompensation_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 3) Batch Correction.
rule TransformCorrect_cells_03_r:
    input:
        script="analysis/03_TransformCorrect_cells_{panel}.Rmd",
        prev_out="docs/02_SpilloverCompensation_cells_{panel}.html",
    output:
        "docs/03_TransformCorrect_cells_{panel}.html"
    benchmark:
        "benchmark/03_TransformCorrect_cells_{panel}.txt"
    threads: 48
    resources:
        mem_mb=376000, #376Gb
        time="36:00:00"
    script:
        "analysis/03_TransformCorrect_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 4) Image QC.
rule QualityControl_cells_04_r:
    input:
        script="analysis/04_QualityControl_cells_{panel}.Rmd",
        prev_out="docs/03_TransformCorrect_cells_{panel}.html",
    output:
        "docs/04_QualityControl_cells_{panel}.html",
    benchmark:
        "benchmark/04_QualityControl_cells_{panel}.txt"
    threads: 8
    resources:
        mem_mb=247000, #247GB
        time="12:00:00"
    script:
        "analysis/04_QualityControl_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 5) Cell Type Annotation; hierarchy 1.
rule CellCategories_cells_05_r:
    input:
        script="analysis/05_CellCategories_cells_{panel}.Rmd",
        prev_out="docs/04_QualityControl_cells_{panel}.html",
    output:
        "docs/05_CellCategories_cells_{panel}.html",
    benchmark:
        "benchmark/05_CellCategories_cells_{panel}.txt"
    threads: 48
    resources:
        mem_mb=350000, #350Gb
        time="24:00:00"
    script:
        "analysis/05_CellCategories_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 6) Cell Type Annotation; hierarchy 2.
rule CellCategories_cells_06_r:
    input:
        script="analysis/06_CellTypes{panel}_cells_{panel}.Rmd",
        prev_out="docs/05_CellCategories_cells_{panel}.html",
    output:
        "docs/06_CellTypes{panel}_cells_{panel}.html",
    benchmark:
        "benchmark/06_CellTypes{panel}_cells_{panel}.txt"
    threads: 48
    resources:
        mem_mb=247000, #350Gb
        time="24:00:00"
    script:
        "analysis/06_CellTypes{panel}_cells_{wildcards.panel}.Rmd"

#-------------------------------------------------------------------
## 7) Cell Type Annotation; hierarchy 3. 
## Immune panel only.
rule CellCategories_cells_07_r:
    input:
        script="analysis/07_ClustersImmune_cells_Immune.Rmd",
        prev_out="docs/06_CellTypesImmune_cells_Immune.html",
    output:
        "docs/07_ClustersImmune_cells_Immune.html",
    benchmark:
        "benchmark/07_ClustersImmune_cells_Immune.txt"
    threads: 48
    resources:
        mem_mb=247000, #350Gb
        time="24:00:00"
    script:
        "analysis/07_ClustersImmune_cells_Immune.Rmd"

#-------------------------------------------------------------------
## 8a) Cell Type Annotation; hierarchy 4. 
## Islet panel only. Input 06.
rule CellCategories_cells_08_Islet_r:
    input:
        script="analysis/08_CellTypesNonIslet_cells_Islet.Rmd",
        prev_out="docs/06_CellTypesIslet_cells_Islet.html",
    output:
        "docs/08_CellTypesNonIslet_cells_Islet.html",
    benchmark:
        "benchmark/08_CellTypesNonIslet_cells_Islet.txt"
    threads: 48
    resources:
        mem_mb=247000, #350Gb
        time="24:00:00"
    script:
        "analysis/08_CellTypesNonIslet_cells_Islet.Rmd"

#-------------------------------------------------------------------
## 8b) Cell Type Annotation; hierarchy 4. 
## Immune panel only. Input 07.
rule CellCategories_cells_08_Immune_r:
    input:
        script="analysis/08_CellTypesNonIslet_cells_Immune.Rmd",
        prev_out="docs/07_ClustersImmune_cells_Immune.html",
    output:
        "docs/08_CellTypesNonImmune_cells_Immune.html",
    benchmark:
        "benchmark/08_CellTypesNonImmune_cells_Immune.txt"
    threads: 48
    resources:
        mem_mb=247000, #350Gb
        time="24:00:00"
    script:
        "analysis/08_CellTypesNonImmune_cells_Immune.Rmd"

#---------------------------------------------------------------------------
# Python-scripts (Preprocessing)
#---------------------------------------------------------------------------
## Scope: 
## Start after Whole-cell Segmentation. 
## End: Image Registraiton.  

# FIXME: Do a test run for preprocessing only first -> also commit new Docker to Singularity + re-build sandbox. 

#---------------------------------------------------------------------------
## 04) Image Registration.
rule Registration_05_py:
    input:
        "T1D_preprocessing/processing/05_ImageRegistration.py",
        "processing/txt_output/04_Measurements.out",
        "T1D_preprocessing/processing/helper_functions.py"
    output:
        "processing/txt_output/05_ImageRegistration.out"
    threads: 8
    resources:
        mem_mb=64000, # 64GB
        time="3:00:00"
    script: "T1D_preprocessing/processing/05_ImageRegistration.py"

#---------------------------------------------------------------------------
## 04) Feature Extraction.
rule Measurements_04_py:
    input: 
        "T1D_preprocessing/processing/04_Measurements.py",
    output: 
        "T1D_preprocessing/processing/txt_output/04_Measurements.out"
    threads: 8
    resources:
        mem_mb=120000, # 120GB
        time="10:00:00"
    script: "T1D_preprocessing/processing/04_Measurements.py"
