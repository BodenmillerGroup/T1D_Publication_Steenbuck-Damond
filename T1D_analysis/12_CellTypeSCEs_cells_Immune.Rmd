---
title: "12_CellTypeSCEs_cells_Immune"
author: "Nicolas Damond"
date: "Created: 05 November, 2022; Compiled: `r format(Sys.time(), '%d %b, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
if (rstudioapi::isAvailable()) {
  script_name <- basename(rstudioapi::getSourceEditorContext()$path)
} else {
  script_name <- knitr::current_input()
}

cur_user <- Sys.info()[["user"]]
script_name <- "12_CellTypeSCEs_cells_Immune.Rmd"

if (cur_user == "ubuntu") {
    source(file.path("/", "mnt", "central_nas", "projects", 
    "type1_diabetes", "nathan", "T1D_Vol", "T1D_analysis", 
    "analysis", "helpers.R"))  #n_cores <- future::availableCores() - 1
  #n_cores <- future::availableCores() - 1
  n_cores <- 4
  future::plan(future::multicore(workers = n_cores))
  paths <- getPaths(script_name)
  knitr::opts_knit$set(root_dir = paths$home_data)
  do_print <- FALSE
} else {
  source(file.path("/", "home", "nsteen", "scripts", "T1D_analysis", "analysis", "helpers.R"))
  n_cores <- 8
  future::plan(future::multicore(workers = n_cores))
  paths <- getPaths(script_name)
  paths$folder_script <- paths$cluster_folder_script
  paths$folder_in <- paths$cluster_folder_in
  paths$folder_out <- paths$cluster_home 
  knitr::opts_knit$set(root_dir = paths$cluster_home)
  do_print <- TRUE
}

seed <- 123456
set.seed(seed)
options <- furrr::furrr_options(seed = seed)
paths$prev <- paste("08_CellTypesIslet", paths$object_type, paths$panel_type, sep = "_")
knitr::opts_chunk$set(echo = TRUE)
```

Rscript -e "rmarkdown::render('T1D_analysis/analysis/12_CellTypeSCEs_cells_Immune.Rmd')"


# **Goal**

The goal of this script is to generate separate SCE objects for each of the 
main cell types in the dataset.  


# **Settings**  

## Load packages

```{r packages, results='hide'}
suppressPackageStartupMessages(c(
  library(data.table),
  library(dplyr),
  library(SpatialExperiment)
))
```

## Paths and settings

```{r settings}
# Paths
if (!dir.exists(paths$folder_script)) dir.create(paths$folder_script)
plotsave_param$path <- paths$folder_script
plotsave_param_large$path <- paths$folder_script

# Misc settings
today <- gsub("-", "", Sys.Date())
```

##  Read in the data

Load the SpatialExperiment (SPE) object saved at the previous step.

```{r load-data}
fn_spe <- file.path(paths$folder_out, paths$prev, paste0(paths$object_type, "_", paths$panel_type, ".rds"))
spe <- readRDS(fn_spe)
print(spe)
```

If it already exists, load the list that contains an SCE object for each cell type.

```{r load-spe-list}
fn_spes <- file.path(paths$folder_script, paste0("celltypes", "_", paths$panel_type, '.rds'))

if (file.exists(fn_spes)) {
  exists_spes <- TRUE
  spes <- readRDS(fn_spes)
  print(spes)
} else {
  exists_spes <- FALSE
}
```


# **Generate the SCEs**

## Define the channels

Define the markers expressed in each cell type.


## Define the channels for lymphocyte cell types
```{r def-channels}
celltypes <- c("T_CD4", "T_CD8", "B", "NK", "Myeloid", "Neutrophil")

cts <- c("Lymphocyte", "Myeloid", "Neutrophil")

# Define the channels for each of the cell types
channels_all <- c("LDHA", "TMEM173")

channels <- list()
# we add CD303 (potential pDCs) to lymphocytes, as they often cluster together with B-cells in previous script.
# Consider to delete CD103 (noisy)
channels[[cts[1]]] <- sort(c(
  "CD3e", "CD4", "CD7", "CD8a", "CD20", "FoxP3",
  "HLA_DR", "CD45RA", "CD45RO",
  "CD57", "CD56",
  "GranB", "CD103",
  "CD27", "CD73", "TIM3", "PD1", 
  "CS", "HK1", "ATP5A",
  "CD303", channels_all))
channels[[cts[2]]] <- sort(c(
  "CD11b", "CD11c", "CD16", "CD163", "CD204", "CD206",
  "HLA_DR",
  "CD57", "CD56", "CD54", # Why these ones?
  "GranB", 
  "CD27", "CD73", "TIM3", "PD1", 
  "CS", "HK1", "ATP5A", 
  "CD303", "MPO", "Arg1", "SMA",
  channels_all))
channels[[cts[3]]] <- sort(c(
  "Arg1", "MPO", "CD11b", "CD11c", "CD15", "CD66b",   
  "CD54", "CD45RO", 
  channels_all))
                          
print(channels)

# Add the channels to the metadata of the main SPE object
metadata(spe)$channels <- channels

channels_all_lympho <- c("CD45RA", "CD45RO", "CD56", "CD57", 
                         "CD73", "CD27", "PD1", "TIM3",
                         "LDHA", "HK1", "CS", "ATP5A", 
                         "TMEM173")

metadata(spe)$channels$T_CD4 <- sort(c("CD3e", "GranB", "CD4", "FoxP3", 
                                       "CD103", channels_all_lympho))
  
metadata(spe)$channels$T_CD8 <- sort(c("CD3e", "GranB", "CD8a", "FoxP3", 
                                       "CD103", channels_all_lympho))

metadata(spe)$channels$NK <- sort(c("CD3e", "CD7", "GranB", "FoxP3", "CD103", "CD16",
                                    channels_all_lympho))
                 
metadata(spe)$channels$B <- sort(c("HLA_DR", "CD20", channels_all_lympho))

metadata(spe)$channels$T_DN <- sort(c("CD3e", "CD103", channels_all_lympho))

metadata(spe)$channels$CD303_VIM <- sort(c("CD303", "VIM", channels_all_lympho)) 

# Add the channels to the metadata of the main SPE object
print(metadata(spe)$channels)
```

```{r list-channels}
# Define relevant cell types
channels_all_other <- c("HLA_DR", "CS", "ATP5A", "HK1", "TMEM173", "LDHA", "Ki67")
metadata(spe)$channels$Beta <- c("INS", "NKX6_1", "PDX1", "SYP", "CD27", "CD54", "CD73", channels_all_other)
metadata(spe)$channels$Endothelial <- c("CAV1", "CD27", "CD54", "CD73", channels_all_other)
metadata(spe)$channels$Ductal <- c("PDX1", "CD27", "CD54", "CD73", channels_all_other)
metadata(spe)$channels$Acinar <- c("CD27", "CD54", "CD73", channels_all_other)

celltypes <- c("T_CD4", "T_CD8", "B", "NK", "Neutrophil", "Myeloid",
               "Ductal", "Acinar", "Endothelial", "Beta")
names(celltypes) <- c("cell_type", "cell_type", "cell_type", "cell_type", "cell_type", "cell_type", 
                      "cell_type", "cell_type", "cell_type", "cell_type")

# Define the channels for each of the cell types
channels <- list()

channels[["T_CD4"]] <- metadata(spe)$channels$T_CD4
channels[["T_CD8"]] <- metadata(spe)$channels$T_CD8
channels[["B"]] <- metadata(spe)$channels$B
channels[["NK"]] <- metadata(spe)$channels$NK
channels[["Neutrophil"]] <- metadata(spe)$channels$Neutrophil
channels[["Myeloid"]] <- metadata(spe)$channels$Myeloid
channels[["Ductal"]] <- metadata(spe)$channels$Ductal
channels[["Acinar"]] <- metadata(spe)$channels$Acinar
channels[["Endothelial"]] <- metadata(spe)$channels$Endothelial
channels[["Beta"]] <- metadata(spe)$channels$Beta
print(channels)

# Add the channels to the metadata of the main SCE object
metadata(spe)$channels <- channels
```

## Generate a list of SCE objects

```{r generate-spe-list}
if (isFALSE(exists_spes)) {
  # Generate the SCE list
  spes <- list()
  for (h in seq_along(celltypes)){
    # Subset by channel and cell type
    level <- names(celltypes[h])
    spes[[h]] <- spe[channels[[h]], spe[[level]] == celltypes[h]]
    
    # Add channels to the metadata
    metadata(spes[[h]])$channels <- metadata(spe)$channels[[celltypes[h]]]
    
    # Remove original reduced dimensions
    reducedDims(spes[[h]]) <- NULL
    
    # Name the SCE objects
    mainExpName(spes[[h]]) <- celltypes[h]
  }
  names(spes) <- celltypes
}
```

## Save the main SCE

`metadata(spe)$channels` now contains a list of channels expressed in each cell type.

```{r save-spe}
fn_spe <- file.path(paths$folder_out, paths$prev, paste0(paths$object_type, "_", paths$panel_type, ".rds"))
print(spe)
saveRDS(spe, fn_spe)
```

## Save the SCEs list

```{r save-spe-list}
print(spes)
saveRDS(spes, fn_spes)
```
